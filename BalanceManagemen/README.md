## Микросерсвис BalanceManagemen

## Бизнес требование

### Цель

Реализация возможности у пользователей иметь свой баланс и единый механизм списания средств с баланса.

### Сценарий 1: Создание баланса пользователя

Вызывается метод POST /balance/userBalance, на вход передается:

- systemToken: системный токен
- ctn: номер телефона

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Обращается к таблице usersBalance (база данных), проверяет наличие баланса по номеру телефона.
4. Если баланс найден, сценарий завершается ошибкой BALANCE_ALREADY_CREATED.
5. Если баланс не найден, создает новую запись в таблице usersBalance со значением баланса по умолчанию (0).
6. Формирует ответ: status (success или error).

### Сценарий 2: Получение баланса пользователя

Вызывается метод GET /balance/userBalance, на вход передается:

- systemToken: системный токен
- ctn: номер телефона

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Обращается к таблице usersBalance (база данных), проверяет наличие баланса по номеру телефона.
4. Если баланс не найден, сценарий завершается ошибкой BALANCE_NOT_FOUND.
5. Получает значение баланса из таблицы.
6. Формирует ответ: status (success или error), balance (сумма баланса).

### Сценарий 3: Изменение баланса пользователя

Вызывается метод PUT /balance/userBalance, на вход передается:

- systemToken: системный токен
- ctn: номер телефона
- operation: тип операции (plus или minus)
- value: значение изменения
- description: описание изменения (необязательно)

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Проверяет соответствие типа операции одному из значений: plus, minus.
4. Обращается к таблице usersBalance (база данных), проверяет наличие баланса по номеру телефона.
5. Если баланс не найден, сценарий завершается ошибкой BALANCE_NOT_FOUND.
6. Получает текущее значение баланса.
7. Если операция "minus" и существует финансовая блокировка, сценарий завершается ошибкой CLIENT_IS_BLOCKED.
8. Изменяет баланс пользователя в зависимости от типа операции.
9. Если новый баланс < 0, создает блокировку "finBlock".
10. Если баланс >= 0 и есть финансовая блокировка, удаляет ее.
11. Сохраняет запись об изменении баланса в таблице usersOperationHistory.
12. Формирует ответ: status (success или error).

## Сценарий 4: Получение истории операций у пользователя

Вызывается метод GET /balance/userOperationHistory, на вход передается:

- systemToken: системный токен
- ctn: номер телефона

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Обращается к таблице usersOperationHistory (база данных) и получает историю операций по номеру телефона.
4. Формирует ответ: status (success или error), operationHistory: [ {operation}, {operation}… ].

## Сценарий 5: Получение ежедневной операции у пользователя

Вызывается метод GET /balance/userOperation, на вход передается:

- systemToken: системный токен
- ctn: номер телефона
- name: техническое наименование операции

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Обращается к таблице usersOperationList (база данных) и получает ежедневную операцию по номеру телефона и названию операции.
4. Формирует ответ: status (success или error), userOperation: [ {operation} ].

## Сценарий 6: Создание ежедневной операции у пользователя

Вызывается метод POST /balance/userOperation, на вход передается:

- systemToken: системный токен
- body:
  - name: техническое наименование операции
  - ctn: номер телефона
  - operation: тип операции (plus или minus)
  - value: значение изменения
  - active: статус активности операции
  - description: описание изменения (необязательно)

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Проверяет соответствие типа операции одному из значений: plus, minus.
4. Обращается к таблице usersOperationList (база данных) и проверяет наличие запланированной операции по номеру телефона и названию операции.
5. Если операция уже существует, сценарий завершается ошибкой OPERATION_ALREADY_CREATED.
6. Создает запись в таблице usersOperationList со значениями из входных параметров.
7. Формирует ответ: status (success или error).

## Сценарий 7: Изменение ежедневной операции у пользователя

Вызывается метод PUT /balance/userOperation, на вход передается:

- systemToken: системный токен
- body:
  - name: техническое наименование операции
  - ctn: номер телефона
  - operation: тип операции (plus или minus)
  - value: значение изменения
  - active: статус активности операции
  - description: описание изменения (необязательно)

(Продолжение)

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Проверяет соответствие типа операции одному из значений: plus, minus.
4. Обращается к таблице usersOperationList (база данных) и проверяет наличие запланированной операции по номеру телефона и названию операции.
5. Если операция не найдена, сценарий завершается ошибкой OPERATION_NOT_FOUND.
6. Изменяет найденную запись в таблице usersOperationList со значениями из входных параметров.
7. Формирует ответ: status (success или error).

## Сценарий 8: Удаление ежедневной операции у пользователя

Вызывается метод DELETE /balance/userOperation, на вход передается:

- systemToken: системный токен
- name: техническое наименование операции
- ctn: номер телефона

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Обращается к таблице usersOperationList (база данных) и проверяет наличие запланированной операции по номеру телефона и названию операции.
4. Если операция не найдена, сценарий завершается ошибкой OPERATION_NOT_FOUND.
5. Удаляет найденную запись из таблицы usersOperationList.
6. Формирует ответ: status (success или error).

## Сценарий 9: Получение списка ежедневных операций у пользователя

Вызывается метод GET /balance/userOperationList, на вход передается:

- systemToken: системный токен
- ctn: номер телефона

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Обращается к таблице usersOperationList (база данных) и получает выборку ежедневных операций по номеру телефона.
4. Формирует ответ: status (success или error), userOperationList: [ {operation}, {operation}… ].

## Сценарий 10: Получение суммы ежедневных операций у пользователя

Вызывается метод GET /balance/userOperationListSum, на вход передается:

- systemToken: системный токен
- ctn: номер телефона

1. Бекенд вызывает метод GET /sec/checkSystemToken микросервиса Система токенов, передавая параметры ctn и token.
2. Проверяет ответ от /sec/checkToken. Если есть ошибка, сценарий завершается ошибкой TOKEN_ERROR.
3. Обращается к таблице usersOperationList (база данных) и получает выборку ежедневных операций по номеру телефона.
4. Делит операции на две группы по полю Active и суммирует результаты двух групп.
5. Формирует ответ: status (success или error), userIsActiveSumm: {{summ}}, userNotActiveSumm: {{summ}}.

## Технический сценарий. Ежедневные операции у пользователей:

- Должен быть создан поток, который каждый день в 2:00 по МСК производит операции у всех пользователей.
- Операции должны быть залогированы.
- Операции должны быть отражены в таблице usersOperationHistory (база данных).
- Бекенд получает из таблицы usersOperationList список операций со статусом "active" = true и сортирует их по пользователям.
- По каждой операции бекенд отправляет запрос к методу PUT /balance/userBalance микросервиса Балансы пользователей с параметрами, полученными из шага 1.
- После обработки всех пользователей, бекенд логирует запись о том, сколько всего начислено средств и сколько списано средств.


## База данных

### Таблица usersBalance

| Поле       | Описание       |
|------------|----------------|
| ctn        | Номер телефона |
| balance    | Баланс         |

### Таблица usersOperationHistory

| Поле        | Описание            |
|-------------|---------------------|
| ctn         | Номер телефона      |
| operation   | Тип операции        |
| value       | Сумма               |
| description | Описание операции   |
| date        | Дата операции       |

### Таблица usersOperationList

| Поле               | Описание                            |
|--------------------|-------------------------------------|
| name               | Наименование операции               |
| ctn                | Номер телефона                     |
| operation          | Тип операции                       |
| value              | Сумма                              |
| description        | Описание операции                  |
| Active             | Boolean. Активна ли операция       |
| DateLastWithdrawal | Дата последней операции            |

## Ошибки

| Код ошибки              | Сообщение передаваемое на фронт |
|-------------------------|----------------------------------|
| BALANCE_ALREADY_CREATED | Баланс уже создан                |
| BALANCE_NOT_FOUND       | Баланс не найден                 |
| OPERATION_TYPE_NOT_FOUND| Тип операции не найден           |
| OPERATION_ALREADY_CREATED | Операция уже создана           |
| OPERATION_NOT_FOUND     | Операция не найдена              |
